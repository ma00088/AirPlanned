{% extends "base.html" %}

{% block title %}Payment - AirPlanned{% endblock %}

{% block content %}
<div class="payment-container">
    <div class="booking-summary">
        <h2>Booking Summary</h2>
        <div class="summary-details">
            <div class="detail-row">
                <span>Flight:</span>
                <span>{{ booking[3] }}</span>
            </div>
            <div class="detail-row">
                <span>Route:</span>
                <span>{{ booking[4] }} → {{ booking[5] }}</span>
            </div>
            <div class="detail-row">
                <span>Date:</span>
                <span>{{ booking[6]|format_date }} at {{ booking[7]|format_time }}</span>
            </div>
            <div class="detail-row">
                <span>Passenger:</span>
                <span>{{ booking[1] }}</span>
            </div>
            <div class="detail-row">
                <span>Seat:</span>
                <span>{{ booking[2] }}</span>
            </div>
            <div class="detail-row total">
                <span>Total Amount:</span>
                <span class="price">${{ "%.2f"|format(booking[8]) }}</span>
            </div>
        </div>
    </div>

    <div class="payment-form-container">
        <h3>Payment Information</h3>
        
        <form method="POST" action="{{ url_for('process_payment') }}" class="payment-form" novalidate>
            <input type="hidden" name="booking_id" value="{{ booking[0] }}">
            
            <div class="form-group">
                <label for="card_number">Card Number *</label>
                <input type="text" name="card_number" id="card_number" class="form-control" 
                       placeholder="1234 5678 9012 3456" maxlength="19" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="expiry_date">Expiry Date *</label>
                    <input type="text" name="expiry_date" id="expiry_date" class="form-control" 
                           placeholder="MM/YY" maxlength="5" required>
                </div>
                
                <div class="form-group">
                    <label for="cvv">CVV *</label>
                    <input type="text" name="cvv" id="cvv" class="form-control" 
                           placeholder="123" maxlength="3" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="cardholder_name">Cardholder Name *</label>
                <input type="text" name="cardholder_name" id="cardholder_name" class="form-control" 
                       placeholder="John Doe" required value="{{ booking[1] }}">
            </div>
            
            <div class="billing-address">
                <h4>Billing Address</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="billing_country">Country *</label>
                        <select name="billing_country" id="billing_country" class="form-control" required>
                            <option value="">Select Country</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="UK">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="FR">France</option>
                            <option value="DE">Germany</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="billing_zip">ZIP/Postal Code *</label>
                        <input type="text" name="billing_zip" id="billing_zip" class="form-control" 
                               placeholder="12345" required>
                    </div>
                </div>
            </div>
            
            <div class="security-info">
                <h4>Security Information</h4>
                <ul>
                    <li>Your payment information is secured with 256-bit SSL encryption</li>
                    <li>We never store your complete card details</li>
                    <li>This transaction is processed in a secure environment</li>
                    <li>All payments are processed by our certified payment partners</li>
                </ul>
            </div>
            
            <div class="terms-section">
                <label class="checkbox-container">
                    <input type="checkbox" name="payment_terms" required>
                    <span class="checkmark"></span>
                    I agree to the payment terms and authorize this transaction
                </label>
            </div>
            
            <div class="payment-actions">
                <button type="submit" class="btn btn-success btn-large">
                    Complete Payment - ${{ "%.2f"|format(booking[8]) }}
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel Payment</a>
            </div>
        </form>
    </div>
</div>

<script>
// Format card number input
document.getElementById('card_number').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '');
    let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
    if (formattedValue.length > 19) formattedValue = formattedValue.substring(0, 19);
    e.target.value = formattedValue;
});

// Format expiry date input
document.getElementById('expiry_date').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    e.target.value = value;
});

// CVV input validation
document.getElementById('cvv').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
});

// Form validation
document.querySelector('.payment-form').addEventListener('submit', function(e) {
    const cardNumber = document.getElementById('card_number').value.replace(/\s/g, '');
    const expiryDate = document.getElementById('expiry_date').value;
    const cvv = document.getElementById('cvv').value;
    const cardholderName = document.getElementById('cardholder_name').value.trim();
    const billingCountry = document.getElementById('billing_country').value;
    const billingZip = document.getElementById('billing_zip').value.trim();
    const paymentTerms = document.querySelector('input[name="payment_terms"]').checked;
    
    // Validate card number
    if (cardNumber.length !== 16 || !/^\d{16}$/.test(cardNumber)) {
        e.preventDefault();
        alert('Card number must be exactly 16 digits');
        document.getElementById('card_number').focus();
        return;
    }
    
    // Validate expiry date
    if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
        e.preventDefault();
        alert('Please enter expiry date in MM/YY format');
        document.getElementById('expiry_date').focus();
        return;
    }
    
    // Check if expiry date is in the future
    const [month, year] = expiryDate.split('/');
    const expiryMonth = parseInt(month);
    const expiryYear = parseInt('20' + year);
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth() + 1;
    
    if (expiryYear < currentYear || (expiryYear === currentYear && expiryMonth < currentMonth)) {
        e.preventDefault();
        alert('Card expiry date must be in the future');
        document.getElementById('expiry_date').focus();
        return;
    }
    
    // Validate CVV
    if (cvv.length !== 3 || !/^\d{3}$/.test(cvv)) {
        e.preventDefault();
        alert('CVV must be exactly 3 digits');
        document.getElementById('cvv').focus();
        return;
    }
    
    // Validate cardholder name
    if (cardholderName.length < 2) {
        e.preventDefault();
        alert('Please enter a valid cardholder name');
        document.getElementById('cardholder_name').focus();
        return;
    }
    
    // Validate billing info
    if (!billingCountry) {
        e.preventDefault();
        alert('Please select your billing country');
        document.getElementById('billing_country').focus();
        return;
    }
    
    if (billingZip.length < 3) {
        e.preventDefault();
        alert('Please enter a valid ZIP/postal code');
        document.getElementById('billing_zip').focus();
        return;
    }
    
    // Validate payment terms
    if (!paymentTerms) {
        e.preventDefault();
        alert('Please agree to the payment terms to proceed');
        return;
    }
    
    // Show processing message
    const submitButton = e.target.querySelector('button[type="submit"]');
    submitButton.innerHTML = 'Processing Payment...';
    submitButton.disabled = true;
});
</script>

<style>
.billing-address {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1.5rem 0;
    border: 1px solid #e2e8f0;
}

.billing-address h4 {
    margin-bottom: 1rem;
    color: #374151;
}

.terms-section {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #fffbeb;
    border-radius: 8px;
    border: 1px solid #fbbf24;
}

.checkbox-container {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    line-height: 1.4;
}

.checkbox-container input[type="checkbox"] {
    margin-right: 0.5rem;
    margin-top: 0.1rem;
    transform: scale(1.2);
}

.security-info {
    background: #f0f9ff;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1.5rem 0;
    border: 1px solid #0ea5e9;
}

.security-info h4 {
    color: #0c4a6e;
    margin-bottom: 1rem;
}

.security-info ul {
    list-style: none;
    padding: 0;
}

.security-info li {
    color: #0c4a6e;
    margin-bottom: 0.5rem;
    position: relative;
    padding-left: 1.5rem;
}

.security-info li:before {
    content: "•";
    position: absolute;
    left: 0;
    font-weight: bold;
}
</style>
{% endblock %}